// src/pages/InternshipApplyPage.tsx
import React, { useMemo, useState, useCallback } from "react";
import { Link, useParams, useNavigate } from "react-router-dom";

type RoleId = "frontend" | "backend" | "marketing";

type RoleConfig = {
  id: RoleId;
  title: string;
  label: string;
  department: string;
  location: string;
  type: string;
  seatsTotal: number;
  seatsOpen: number;
  intro: string;
  responsibilities: string[];
  requirements: string[];
  outcomes: string[];
  compensationNote: string;
};

const ROLES: Record<RoleId, RoleConfig> = {
  frontend: {
    id: "frontend",
    title: "Front-End Developer — Product Interfaces (Intern)",
    label: "Front-End Developer · Internship",
    department: "ENGINEERING",
    location: "Remote Worldwide",
    type: "Paid Internship",
    seatsTotal: 4,
    seatsOpen: 4,
    intro:
      "You’ll work on the DNDX marketing site and product surfaces — fast, clean interfaces that feel as considered as the underlying protocol.",
    responsibilities: [
      "Implement UI components and flows in React + Vite + Tailwind, from specs and design mocks.",
      "Help keep the site and app responsive across devices and breakpoints.",
      "Polish details: hover states, loading states, error messages, micro-interactions.",
      "Pair with design and back-end to wire real data into interfaces.",
    ],
    requirements: [
      "You’re in Computer Science or a related technical field, or a recent graduate.",
      "Hands-on experience with React and modern JavaScript/TypeScript.",
      "Comfortable with Git/GitHub and basic CLI workflows.",
      "At least one real project: a site, dashboard, or app you can show and walk through.",
    ],
    outcomes: [
      "Ship production interfaces used by real merchants and partners.",
      "Get detailed feedback on code quality, structure, and UX decisions.",
      "Learn how design handoff, review and deployment actually work in a small product team.",
    ],
    compensationNote:
      "This is a paid internship. Final stipend details are shared during the selection process and depend on location and weekly time commitment.",
  },
  backend: {
    id: "backend",
    title: "Back-End Developer — Payments & Data (Intern)",
    label: "Back-End Developer · Internship",
    department: "ENGINEERING",
    location: "Remote Worldwide",
    type: "Paid Internship",
    seatsTotal: 4,
    seatsOpen: 4,
    intro:
      "You’ll help wire up the pipes behind DNDX — APIs, data flows and storage that keep commerce-grade payments safe and observable.",
    responsibilities: [
      "Build and maintain small APIs and services for payments, analytics, and internal tools.",
      "Work with SQL databases and services like Supabase / Firebase for data access.",
      "Partner with front-end and product to design clear, stable API contracts.",
      "Take security, logging and correctness seriously, even in experiments.",
    ],
    requirements: [
      "You’re in Computer Science or a related technical field, or a recent graduate.",
      "Some hands-on experience with Node.js / TypeScript or a similar back-end stack.",
      "You can read and write SQL, and understand basic schema design.",
      "Curiosity about reliability, transactions, and how real money systems stay safe.",
    ],
    outcomes: [
      "Touch real payment-adjacent code and data models, not toy examples.",
      "Learn how to design and evolve APIs without breaking existing clients.",
      "Get feedback on architecture decisions and trade-offs, not just syntax.",
    ],
    compensationNote:
      "This is a paid internship. Final stipend details are shared during the selection process and depend on location and weekly time commitment.",
  },
  marketing: {
    id: "marketing",
    title: "Marketing & Community — Growth Intern",
    label: "Marketing & Community · Internship",
    department: "GROWTH",
    location: "Remote Worldwide",
    type: "Paid Internship",
    seatsTotal: 4,
    seatsOpen: 4,
    intro:
      "You’ll help tell the DNDX story: own social channels, ship campaigns and keep a tight feedback loop with builders and merchants.",
    responsibilities: [
      "Plan and publish content across X, LinkedIn, Farcaster and Discord.",
      "Turn product launches, changes and roadmap into clear narrative arcs.",
      "Help track basic metrics: reach, engagement, signups and replies.",
      "Collaborate with design and engineering to pull real product into content.",
    ],
    requirements: [
      "You’re in Computer Science, Business, Marketing or a related field, or a recent graduate.",
      "Strong written English and the ability to explain technical ideas in simple language.",
      "You live on the internet: you understand how crypto / fintech conversations move online.",
      "You’re comfortable taking ownership for a channel or small campaign end-to-end.",
    ],
    outcomes: [
      "Build a real portfolio of posts, threads and small campaigns tied to actual product work.",
      "Learn how product, marketing and community talk to each other in a small team.",
      "Get direct feedback on messaging, tone, positioning and experiment design.",
    ],
    compensationNote:
      "This is a paid internship. Final stipend details are shared during the selection process and depend on location and weekly time commitment.",
  },
};

type ToggleKey =
  | "eligible"
  | "resume"
  | "links"
  | "motivation"
  | "availability";

function buildMailto(role: RoleConfig): string {
  const subject = encodeURIComponent(
    `Application: ${role.title} — Internship @ Dendrites`
  );

  const body = encodeURIComponent(
    `Hi Dendrites team,

I'd like to apply for the ${role.title} (${role.type}).

Name:
Current city & time zone:
University / current status (e.g. 3rd year CS, recent graduate):

Links:
- Resume (PDF):
- Portfolio / GitHub:
- LinkedIn / X / Farcaster (optional):

Why I believe I'm a strong fit for this internship:
- (2–6 short bullet points on relevant work, interests, and how you think about this space.)

Availability:
- Earliest start date:
- Weekly hours you can commit:
- Any constraints (exams, other commitments):

Anything else you'd like to know about me:

Best,
[Your name here]`
  );

  return `mailto:hello@dendrites.ai?subject=${subject}&body=${body}`;
}

function ToggleRow(props: {
  label: string;
  description?: string;
  checked: boolean;
  onToggle: () => void;
}) {
  const { label, description, checked, onToggle } = props;

  return (
    <button
      type="button"
      onClick={onToggle}
      className={`w-full flex items-center justify-between gap-3 rounded-2xl border px-4 py-3 sm:px-5 sm:py-3.5 text-left transition-colors
      ${
        checked
          ? "border-[#1850ebff] bg-white/[0.04]"
          : "border-white/10 bg-white/[0.02] hover:border-white/25"
      }`}
    >
      <div className="flex-1">
        <p className="text-xs sm:text-sm font-medium text-white">
          {label}
        </p>
        {description && (
          <p className="mt-0.5 text-[11px] sm:text-xs text-white/55">
            {description}
          </p>
        )}
      </div>
      <div
        className={`relative h-5 w-9 rounded-full border transition-colors ${
          checked ? "border-[#1850ebff] bg-[#1850eb33]" : "border-white/25"
        }`}
      >
        <span
          className={`absolute top-[2px] h-4 w-4 rounded-full bg-white shadow-sm transition-all duration-200 ${
            checked ? "right-[2px]" : "left-[2px]"
          }`}
        />
      </div>
    </button>
  );
}

export default function InternshipApplyPage() {
  const { roleId } = useParams<{ roleId?: string }>();
  const navigate = useNavigate();

  const role: RoleConfig = useMemo(() => {
    if (!roleId) return ROLES.frontend;
    if (roleId === "backend" || roleId === "marketing" || roleId === "frontend")
      return ROLES[roleId];
    return ROLES.frontend;
  }, [roleId]);

  const [toggles, setToggles] = useState<Record<ToggleKey, boolean>>({
    eligible: false,
    resume: false,
    links: false,
    motivation: false,
    availability: false,
  });

  const allChecked = Object.values(toggles).every(Boolean);
  const mailtoHref = useMemo(() => buildMailto(role), [role]);

  const toggle = useCallback((key: ToggleKey) => {
    setToggles((prev) => ({ ...prev, [key]: !prev[key] }));
  }, []);

  const handleApplyClick = useCallback(() => {
    if (!allChecked) return;
    
    // Try multiple methods for cross-platform compatibility
    try {
      // Method 1: Create a temporary anchor and simulate click (most reliable)
      const link = document.createElement('a');
      link.href = mailtoHref;
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } catch (error) {
      // Fallback: Direct window.location assignment
      console.warn('Mailto click failed, using fallback:', error);
      window.location.href = mailtoHref;
    }
  }, [allChecked, mailtoHref]);

  return (
    <section className="w-full min-h-[100svh] bg-black text-white">
      <div className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-10 py-14 sm:py-18 md:py-20">
        {/* Top nav crumb */}
        <div className="flex items-center justify-between gap-4 mb-8">
          <button
            type="button"
            onClick={() => navigate(-1)}
            className="text-xs sm:text-sm text-white/60 hover:text-white flex items-center gap-1.5"
          >
            <span className="text-base sm:text-lg">←</span>
            Back to internships
          </button>
          <span className="text-[11px] sm:text-xs text-white/40 uppercase tracking-[0.2em]">
            APPLICATION · DNDX
          </span>
        </div>

        {/* Header card */}
        <div className="rounded-3xl border border-white/15 bg-gradient-to-br from-white/[0.03] via-black to-black/95 px-5 sm:px-7 md:px-9 py-6 sm:py-8 md:py-9 shadow-[0_24px_80px_rgba(0,0,0,0.9)] mb-10 sm:mb-12">
          <p className="text-[11px] sm:text-xs uppercase tracking-[0.18em] text-white/50 mb-2">
            {role.department} · Internship
          </p>
          <h1 className="text-2xl sm:text-3xl md:text-[32px] font-semibold tracking-tight">
            {role.title}
          </h1>
          <p className="mt-2 text-sm sm:text-base text-white/65">
            {role.location}
            <span className="mx-2 text-white/30">•</span>
            {role.type}
            <span className="mx-2 text-white/30">•</span>
            {role.seatsOpen} of {role.seatsTotal} seats open
          </p>
          <p className="mt-4 text-sm sm:text-[15px] text-white/70 max-w-3xl">
            {role.intro}
          </p>
          <p className="mt-4 text-[11px] sm:text-xs text-white/50">
            {role.compensationNote}
          </p>
        </div>

        {/* Main grid */}
        <div className="grid gap-10 lg:gap-12 lg:grid-cols-[minmax(0,1.1fr)_minmax(0,1.1fr)]">
          {/* Left: checklist & apply */}
          <div className="space-y-5 sm:space-y-6">
            <div>
              <h2 className="text-sm sm:text-base font-semibold tracking-tight mb-1.5">
                Self-assessment checklist
              </h2>
              <p className="text-xs sm:text-sm text-white/60">
                Please confirm you meet these requirements before applying. Check all boxes to generate your email draft.
              </p>
            </div>

            <div className="space-y-3 sm:space-y-3.5">
              <ToggleRow
                label="I’m in Computer Science (or a related field) or a recent graduate."
                checked={toggles.eligible}
                onToggle={() => toggle("eligible")}
              />
              <ToggleRow
                label="I have a resume / CV ready to attach (PDF preferred)."
                checked={toggles.resume}
                onToggle={() => toggle("resume")}
              />
              <ToggleRow
                label="I can share at least one link (GitHub, portfolio, LinkedIn or similar)."
                checked={toggles.links}
                onToggle={() => toggle("links")}
              />
              <ToggleRow
                label="I can write 4–6 sentences on why I’m a strong fit for this internship."
                checked={toggles.motivation}
                onToggle={() => toggle("motivation")}
              />
              <ToggleRow
                label="I have a rough idea of my availability (start date + weekly hours)."
                checked={toggles.availability}
                onToggle={() => toggle("availability")}
              />
            </div>

            <div className="mt-4 space-y-2">
              <button
                type="button"
                onClick={handleApplyClick}
                disabled={!allChecked}
                className={`w-full rounded-2xl px-5 py-3.5 text-sm sm:text-base font-semibold transition-all
                ${
                  allChecked
                    ? "bg-white text-black hover:bg-[#f3f4f6] active:scale-[0.98]"
                    : "bg-white/5 text-white/40 cursor-not-allowed"
                }`}
              >
                Open email draft &amp; apply
              </button>
              <p className="text-[11px] sm:text-xs text-white/45">
                We&apos;ll open your default email client with a pre-filled
                template to{" "}
                <span className="font-semibold text-white/70">
                  hello@dendrites.ai
                </span>
                . Attach your resume and edit the text before sending.
              </p>
            </div>
          </div>

          {/* Right: role details */}
          <div className="space-y-5 sm:space-y-6">
            <div className="rounded-2xl border border-white/12 bg-white/[0.01] px-5 py-4 sm:px-6 sm:py-5">
              <h2 className="text-sm sm:text-base font-semibold tracking-tight mb-2">
                What you’ll work on
              </h2>
              <ul className="space-y-1.5 text-xs sm:text-sm text-white/70">
                {role.responsibilities.map((item) => (
                  <li key={item} className="flex gap-2">
                    <span className="mt-[5px] h-[5px] w-[5px] rounded-full bg-[#1850ebff]" />
                    <span>{item}</span>
                  </li>
                ))}
              </ul>
            </div>

            <div className="rounded-2xl border border-white/12 bg-white/[0.01] px-5 py-4 sm:px-6 sm:py-5">
              <h2 className="text-sm sm:text-base font-semibold tracking-tight mb-2">
                Who this is for
              </h2>
              <ul className="space-y-1.5 text-xs sm:text-sm text-white/70">
                {role.requirements.map((item) => (
                  <li key={item} className="flex gap-2">
                    <span className="mt-[5px] h-[5px] w-[5px] rounded-full bg-white/60" />
                    <span>{item}</span>
                  </li>
                ))}
              </ul>
            </div>

            <div className="rounded-2xl border border-white/12 bg-white/[0.01] px-5 py-4 sm:px-6 sm:py-5">
              <h2 className="text-sm sm:text-base font-semibold tracking-tight mb-2">
                What you’ll get out of it
              </h2>
              <ul className="space-y-1.5 text-xs sm:text-sm text-white/70">
                {role.outcomes.map((item) => (
                  <li key={item} className="flex gap-2">
                    <span className="mt-[5px] h-[5px] w-[5px] rounded-full bg-emerald-400/80" />
                    <span>{item}</span>
                  </li>
                ))}
              </ul>
              <p className="mt-3 text-[11px] sm:text-xs text-white/45">
                We also provide a completion letter describing what you shipped,
                and we&apos;re happy to support future job applications with a
                reference when the internship has gone well.
              </p>
            </div>

            <div className="text-[11px] sm:text-xs text-white/40">
              <p>
                DNDX internships are structured around real work and tight
                feedback loops. If you&apos;re serious about learning and
                shipping, we&apos;ll take your application seriously.
              </p>
            </div>
          </div>
        </div>

        {/* Tiny bottom crumb */}
        <div className="mt-10 sm:mt-12 flex flex-wrap items-center justify-between gap-3 text-[11px] sm:text-xs text-white/40">
          <span>© 2025 Dendrites AI · Early team building commerce-grade Undo.</span>
          <Link
            to="/careers"
            className="underline decoration-white/30 hover:decoration-[#1850ebff] hover:text-white/70"
          >
            View all open internships
          </Link>
        </div>
      </div>
    </section>
  );
}
